name: Deploy to AWS Lambda

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: rag-text-to-sql-server
  BASE_IMAGE_REPOSITORY: lambda-python-deps
  BASE_IMAGE_TAG: "3.12"
  LAMBDA_FUNCTION: rag-text-to-sql-me

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        run: |
          echo "üßπ Freeing up disk space on GitHub Actions runner..."
          echo ""
          echo "üìä Disk space before cleanup:"
          df -h /
          echo ""

          # Remove unnecessary pre-installed software
          echo "üóëÔ∏è  Removing unnecessary software..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          # Clean up Docker
          echo "üê≥ Cleaning up Docker..."
          docker system prune -af --volumes || true

          # Clean up package caches
          echo "üì¶ Cleaning up package caches..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo ""
          echo "üìä Disk space after cleanup:"
          df -h /
          echo ""
          echo "‚úÖ Cleanup complete!"
          echo ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print deployment info
        run: |
          echo "=========================================="
          echo "üöÄ AWS Lambda Deployment Started"
          echo "=========================================="
          echo "Trigger: Push to main branch"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo ""
          echo "üìã Deployment Configuration:"
          echo "   ‚Ä¢ AWS Region: ${{ env.AWS_REGION }}"
          echo "   ‚Ä¢ ECR Repository: ${{ env.ECR_REPOSITORY }}"
          echo "   ‚Ä¢ Lambda Function: ${{ env.LAMBDA_FUNCTION }}"
          echo "   ‚Ä¢ Platform: linux/amd64"
          echo ""
          echo "‚è±Ô∏è  Estimated deployment time:"
          echo "   ‚Ä¢ First deployment (new AWS account): ~30-35 minutes (builds base image)"
          echo "   ‚Ä¢ Subsequent deployments: ~5-7 minutes (uses cached base image)"
          echo "=========================================="
          echo ""

      - name: Set up Docker
        run: |
          echo "üîß Verifying Docker installation..."
          docker version
          echo "‚úÖ Docker ready!"
          echo ""

      - name: Configure AWS credentials
        run: |
          echo "üîê Configuring AWS credentials..."

      - name: Configure AWS credentials (action)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          echo "‚úÖ AWS credentials configured!"
          echo "Region: ${{ env.AWS_REGION }}"
          aws sts get-caller-identity
          echo ""

      - name: Login to Amazon ECR
        run: |
          echo "üîê Logging into Amazon ECR..."

      - name: Login to Amazon ECR (action)
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify ECR login
        run: |
          echo "‚úÖ Successfully logged into ECR!"
          echo "Registry: ${{ steps.login-ecr.outputs.registry }}"
          echo ""

      - name: Check and build base image if needed
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "=========================================="
          echo "üîç Checking for Lambda Base Image"
          echo "=========================================="
          echo "Repository: ${{ env.BASE_IMAGE_REPOSITORY }}"
          echo "Tag: ${{ env.BASE_IMAGE_TAG }}"
          echo "Full image: $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }}"
          echo ""

          # Try to pull the base image
          if docker pull $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }} 2>/dev/null; then
            echo "‚úÖ Base image found in ECR - using cached version"
            echo "   This is the fast path (deployment will take ~5-7 minutes)"
            echo ""
          else
            echo "‚ö†Ô∏è  Base image not found in ECR"
            echo "   This is expected for first-time setup or new AWS accounts"
            echo ""
            echo "=========================================="
            echo "üèóÔ∏è  Building Lambda Base Image (One-Time)"
            echo "=========================================="
            echo "‚è±Ô∏è  This will take 25-30 minutes (one-time only)"
            echo "   Future deployments will be 6-7x faster!"
            echo ""
            echo "üì¶ Building base image with system dependencies..."
            echo "   - PDF processing: poppler, poppler-utils, poppler-glib"
            echo "   - Rendering: cairo, pango, freetype, harfbuzz"
            echo "   - OpenGL: mesa-libGL, mesa-libGLU, mesa-libgbm"
            echo "   - X11: libX11, libXext, libXrender, libxcb"
            echo "   - Image formats: libpng, libjpeg-turbo, libtiff"
            echo "   - Build tools: gcc, gcc-c++"
            echo ""

            # Build the base image
            docker build \
              --platform linux/amd64 \
              -f Dockerfile.lambda.base \
              -t $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }} \
              .

            echo ""
            echo "‚úÖ Base image built successfully!"
            echo ""
            echo "üì§ Pushing base image to ECR..."
            docker push $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }}
            echo ""
            echo "=========================================="
            echo "‚úÖ Base Image Setup Complete!"
            echo "=========================================="
            echo "üéâ Base image is now cached in ECR"
            echo "   All future deployments will use this cached image"
            echo "   Expected deployment time: ~5-7 minutes (6-7x faster!)"
            echo ""

            # Clean up Docker to free space for application build
            echo "üßπ Cleaning up Docker build cache to free disk space..."
            docker system prune -f
            echo "‚úÖ Cleanup complete"
            echo ""
          fi

          # Show disk space after base image handling
          echo "üìä Disk space status:"
          df -h / | grep -E "Filesystem|/$"
          echo ""

      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üî® Building Docker image..."
          echo "   Platform: linux/amd64"
          echo "   Image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   Base Image Registry: $ECR_REGISTRY"
          echo ""

          docker build \
            --platform linux/amd64 \
            --build-arg ECR_REGISTRY=$ECR_REGISTRY \
            -f Dockerfile.lambda \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:amd64 \
            .

          echo "‚úÖ Build complete!"
          echo ""

      - name: Push images to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "üì§ Pushing images to ECR..."
          echo "   Pushing 3 tags: $IMAGE_TAG, latest, amd64"
          echo ""

          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:amd64

          echo "‚úÖ All images pushed successfully!"
          echo ""

      - name: Print build summary
        run: |
          echo "=========================================="
          echo "‚úÖ All images pushed to ECR successfully!"
          echo "=========================================="
          echo "Image URI: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
          echo "Tags: ${{ github.sha }}, latest, amd64"
          echo "Platform: linux/amd64"
          echo ""

      - name: Update Lambda function
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo ""
          echo "=========================================="
          echo "üöÄ Updating Lambda Function"
          echo "=========================================="
          echo "Function Name: ${{ env.LAMBDA_FUNCTION }}"
          echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Architecture: x86-64"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""

          # Update Lambda function code with x86_64 architecture
          echo "üìù Updating Lambda function code..."
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --architectures x86_64
          echo "‚úÖ Update command sent!"
          echo ""

          # Wait for update to complete
          echo "‚è≥ Waiting for Lambda function to finish updating..."
          echo "   This may take 30-60 seconds..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION }}
          echo "‚úÖ Lambda function updated successfully!"
          echo ""

          # Get function info
          echo "üìä Lambda Function Status:"
          aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --query '{State:Configuration.State,LastUpdateStatus:Configuration.LastUpdateStatus,Architecture:Configuration.Architectures[0],Memory:Configuration.MemorySize,Timeout:Configuration.Timeout}' \
            --output table
          echo ""

          echo "=========================================="
          echo "‚úÖ Lambda deployment completed!"
          echo "=========================================="

      - name: Configure Lambda Environment (S3 Storage + Redis Cache)
        run: |
          echo ""
          echo "=========================================="
          echo "‚öôÔ∏è  Configuring Lambda Environment Variables"
          echo "=========================================="
          echo "Function Name: ${{ env.LAMBDA_FUNCTION }}"
          echo "Storage Backend: S3"
          echo "S3 Bucket: ${{ secrets.S3_CACHE_BUCKET }}"
          echo "Query Cache: Upstash Redis"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo ""

          # Fetch and merge environment variables
          echo "üì• Fetching current environment variables..."
          aws lambda get-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --query 'Environment.Variables' \
            --output json > /tmp/current-vars.json

          echo "üîß Merging S3 storage and Redis cache configuration..."
          jq '. + {
            "STORAGE_BACKEND": "s3",
            "S3_CACHE_BUCKET": "${{ secrets.S3_CACHE_BUCKET }}",
            "PINECONE_API_KEY": "${{ secrets.PINECONE_API_KEY }}",
            "PINECONE_ENVIRONMENT": "${{ secrets.PINECONE_ENVIRONMENT }}",
            "PINECONE_INDEX_NAME": "${{ secrets.PINECONE_INDEX_NAME }}",
            "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
            "DATABASE_URL": "${{ secrets.DATABASE_URL }}",
            "UPSTASH_REDIS_URL": "${{ secrets.UPSTASH_REDIS_URL }}",
            "UPSTASH_REDIS_TOKEN": "${{ secrets.UPSTASH_REDIS_TOKEN }}",
            "ENVIRONMENT": "production",
            "HOME": "/tmp",
            "TMPDIR": "/tmp",
            "TEMP": "/tmp",
            "TMP": "/tmp",
            "HF_HOME": "/tmp/.cache/huggingface",
            "TRANSFORMERS_CACHE": "/tmp/.cache/huggingface",
            "UNSTRUCTURED_CACHE_DIR": "/tmp/.cache/unstructured",
            "DOCLING_CACHE_DIR": "/tmp/.cache/docling",
            "USE_DOCKLING": "false"
          }' /tmp/current-vars.json | jq '{Variables: .}' > /tmp/env-config.json

          echo "üìã Environment configuration to apply:"
          cat /tmp/env-config.json | jq .

          echo ""
          echo "üì§ Updating Lambda environment variables..."
          aws lambda update-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --environment file:///tmp/env-config.json

          echo "‚úÖ Environment variables updated"
          echo ""

          # Wait for update to complete
          echo "‚è≥ Waiting for configuration update to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION }}
          echo "‚úÖ Configuration update complete"
          echo ""

          # Verify configuration
          echo "üîç Verifying S3 storage configuration..."
          STORAGE_BACKEND=$(aws lambda get-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --query 'Environment.Variables.STORAGE_BACKEND' \
            --output text)

          S3_BUCKET=$(aws lambda get-function-configuration \
            --function-name ${{ env.LAMBDA_FUNCTION }} \
            --query 'Environment.Variables.S3_CACHE_BUCKET' \
            --output text)

          echo "   Storage Backend: $STORAGE_BACKEND"
          echo "   S3 Bucket: $S3_BUCKET"
          echo ""

          if [ "$STORAGE_BACKEND" = "s3" ] && [ "$S3_BUCKET" = "${{ secrets.S3_CACHE_BUCKET }}" ]; then
            echo "=========================================="
            echo "‚úÖ S3 Storage Configuration Verified!"
            echo "=========================================="
          else
            echo "=========================================="
            echo "‚ùå Configuration Verification Failed"
            echo "=========================================="
            echo "Expected Storage Backend: s3"
            echo "Actual Storage Backend: $STORAGE_BACKEND"
            echo ""
            echo "Expected S3 Bucket: ${{ secrets.S3_CACHE_BUCKET }}"
            echo "Actual S3 Bucket: $S3_BUCKET"
            exit 1
          fi

      - name: Test deployment
        env:
          API_URL: ${{ secrets.API_GATEWAY_URL }}
        run: |
          echo ""
          echo "=========================================="
          echo "üß™ Testing Lambda Deployment"
          echo "=========================================="
          echo "API Gateway URL: $API_URL"
          echo "Testing: /health and /info endpoints"
          echo ""

          echo "‚è≥ Waiting 10 seconds for Lambda cold start..."
          echo "   (Lambda needs time to initialize services on first invocation)"
          for i in {10..1}; do
            echo -n "   $i seconds remaining..."
            sleep 1
            echo -ne "\r"
          done
          echo "   ‚úÖ Wait complete!"
          echo ""

          # Test health endpoint with retries (Lambda cold start can take time)
          echo "üè• Testing health endpoint with retry logic..."
          echo "   Endpoint: $API_URL/health"
          RETRY=0
          MAX_RETRIES=3
          until curl -f -s "$API_URL/health" > /dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
            RETRY=$((RETRY+1))
            echo "   ‚ö†Ô∏è  Attempt $RETRY/$MAX_RETRIES failed, waiting 5 seconds before retry..."
            sleep 5
          done

          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå DEPLOYMENT TEST FAILED"
            echo "=========================================="
            echo "Health endpoint still returning errors after $MAX_RETRIES attempts"
            echo ""
            echo "üîç Debugging Information:"
            echo "---"
            echo "Full URL: $API_URL/health"
            echo ""
            echo "üì° Verbose curl output:"
            curl -v "$API_URL/health" || true
            echo ""
            echo "üí° Troubleshooting steps:"
            echo "1. Check CloudWatch logs: aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION }} --follow"
            echo "2. Verify API Gateway URL includes /prod: $API_URL"
            echo "3. Check Lambda function status in AWS Console"
            echo "4. Verify environment variables are set in Lambda"
            echo ""
            exit 1
          fi

          echo "   ‚úÖ Health endpoint responding!"
          echo ""
          echo "üìã Health Check Response:"
          echo "---"
          curl -s "$API_URL/health" | head -20
          echo "---"
          echo ""

          # Test info endpoint
          echo "‚ÑπÔ∏è  Testing info endpoint..."
          echo "   Endpoint: $API_URL/info"
          if curl -f -s "$API_URL/info" > /dev/null; then
            echo "   ‚úÖ Info endpoint responding!"
            echo ""
            echo "üìã Info Response:"
            echo "---"
            curl -s "$API_URL/info"
            echo ""
            echo "---"
          else
            echo "   ‚ö†Ô∏è  Info endpoint failed (non-critical, continuing...)"
          fi

          echo ""
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT TEST PASSED!"
          echo "=========================================="
          echo "üéâ Your Lambda function is live and responding!"
          echo ""
          echo "üìä Deployment Summary:"
          echo "   ‚Ä¢ Docker Image: Built for x86-64 (AMD64)"
          echo "   ‚Ä¢ Lambda: Updated successfully"
          echo "   ‚Ä¢ Health Check: ‚úÖ Passing"
          echo "   ‚Ä¢ Info Endpoint: ‚úÖ Passing"
          echo ""
          echo "üîó Your API is ready at: $API_URL"
          echo "=========================================="