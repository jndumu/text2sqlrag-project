name: Deploy to AWS Lambda

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: rag-text-to-sql-server
  BASE_IMAGE_REPOSITORY: lambda-python-deps
  BASE_IMAGE_TAG: "3.12"
  LAMBDA_FUNCTION: rag-text-to-sql-me

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        run: |
          echo "üßπ Freeing up disk space on GitHub Actions runner..."
          echo ""
          echo "üìä Disk space before cleanup:"
          df -h /
          echo ""

          # Remove unnecessary pre-installed software
          echo "üóëÔ∏è  Removing unnecessary software..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

          # Clean up Docker
          echo "üê≥ Cleaning up Docker..."
          docker system prune -af --volumes || true

          # Clean up package caches
          echo "üì¶ Cleaning up package caches..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo ""
          echo "üìä Disk space after cleanup:"
          df -h /
          echo ""
          echo "‚úÖ Cleanup complete!"
          echo ""

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print deployment info
        run: |
          echo "=========================================="
          echo "üöÄ AWS Lambda Deployment Started"
          echo "=========================================="
          echo "Trigger: Push to main branch"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo ""
          echo "üìã Deployment Configuration:"
          echo "   ‚Ä¢ AWS Region: ${{ env.AWS_REGION }}"
          echo "   ‚Ä¢ ECR Repository: ${{ env.ECR_REPOSITORY }}"
          echo "   ‚Ä¢ Lambda Function: ${{ env.LAMBDA_FUNCTION }}"
          echo "   ‚Ä¢ Platform: linux/amd64"
          echo ""
          echo "‚è±Ô∏è  Estimated deployment time:"
          echo "   ‚Ä¢ First deployment (new AWS account): ~30-35 minutes (builds base image)"
          echo "   ‚Ä¢ Subsequent deployments: ~5-7 minutes (uses cached base image)"
          echo "=========================================="
          echo ""

      - name: Set up Docker
        run: |
          echo "üîß Verifying Docker installation..."
          docker version
          echo "‚úÖ Docker ready!"
          echo ""

      - name: Configure AWS credentials
        run: |
          echo "üîê Configuring AWS credentials..."

      - name: Configure AWS credentials (action)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          echo "‚úÖ AWS credentials configured!"
          echo "Region: ${{ env.AWS_REGION }}"
          aws sts get-caller-identity
          echo ""

      - name: Login to Amazon ECR
        run: |
          echo "üîê Logging into Amazon ECR..."

      - name: Login to Amazon ECR (action)
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify ECR login
        run: |
          echo "‚úÖ Successfully logged into ECR!"
          echo "Registry: ${{ steps.login-ecr.outputs.registry }}"
          echo ""

      - name: Check and build base image if needed
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "=========================================="
          echo "üîç Checking for Lambda Base Image"
          echo "=========================================="
          echo "Repository: ${{ env.BASE_IMAGE_REPOSITORY }}"
          echo "Tag: ${{ env.BASE_IMAGE_TAG }}"
          echo "Full image: $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }}"
          echo ""

          # Try to pull the base image
          if docker pull $ECR_REGISTRY/${{ env.BASE_IMAGE_REPOSITORY }}:${{ env.BASE_IMAGE_TAG }} 2>/dev/null; then
            echo "‚úÖ Base image found in ECR - using cached version"
            echo "   This is the fast path (deployment will take ~5-7 minutes)"
            echo ""
          else
            echo "‚ö†Ô∏è  Base image not found in ECR"
            echo "   This is expected for first-time setup or new AWS accounts"
            echo ""
            echo "=========================================="
            echo "üèóÔ∏è  Building Lambda Base Image (One-Time)"
            echo "=========================================="
            echo "‚è±Ô∏è  This will take 25-30 minutes (one-time only)"
            echo "   Future deployments will be 6-7x faster!"
            echo ""
            echo "üì¶ Building base image with system dependencies..."
            echo "   - PDF processing: poppler, poppler-utils, poppler-glib"
            echo "   - Rendering: cairo, pango, freetype, harfbuzz"
            echo "   - OpenGL: mesa-libGL, mesa-libGLU, mesa-libgbm"
            echo "   - X11: libX11, libXext, libXrender, libxcb"
            echo "   - Image formats: libpng, libjpeg-turbo, libtiff"
            echo "   - Build tools: gcc, gcc      

